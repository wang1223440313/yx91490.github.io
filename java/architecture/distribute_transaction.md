# 分布式事务接口

## CAP理论

2000 年 7月，来自加州大学伯克利分校的 Eric Brewer 教授提出了著名的 CAP 猜想。2年后，来自麻省理工学院的 Seth Gilbert 和 Nancy Lynch 从理论上证明了 CAP 可行性，从此 CAP 定理在学术上成为了分布式计算领域公认的定理，影响着分布式计算的发展。

CAP原则包含如下三个元素：

- C（Consistency） ： 一致性。在分布式系统中的所有数据备份，在同一时刻具有同样的值，所有节点在同一时刻读取的数据都是最新的数据副本。
- A（Availability）：可用性，好的响应性能。完全的可用性指的是在任何故障模型下，服务都会在有限的时间内处理完成井进行响应。
- P（Partition tolerance） ：分区容忍性。尽管网络上有部分消息丢失，但系统仍然可继续工作。

CAP 原理证明，任何分布式系统只可同时满足以上两点，无法三者兼顾。

### CAP 证明

参考：[一篇文章搞清楚什么是分布式系统 CAP 定理](https://www.iteblog.com/archives/2390.html)

## Base理论

BASE 是 Basically Available（基本可用）、Soft state（软状态）和 Eventually consistent（最终一致性）三个短语的简写，由 eBay 架构师 Dan Pritchett 于 2008 年在《BASE: An Acid Alternative》论文中首次提出。

BASE 模型包含如下三个元素：

- BA：（**B**asically **A**vailable ），基本可用。
- S：（ **S**oft State），软状态，状态可以在一段时间内不同步。
- E：（**E**ventually Consistent ），最终一致，在一定的时间窗口内， 最终数据达成一致即可。

### 参考

[分布式系统一致性问题、CAP定律以及 BASE 理论](https://www.iteblog.com/archives/2352.html)

## 两阶段提交协议

两阶段提交协议的目标在于为分布式系统保证数据的一致性，许多分布式系统采用该协议提供对分布式事务的支持。

二阶段提交算法的成立基于以下假设：

- 该分布式系统中，存在一个节点作为协调者（Coordinator），其他节点作为参与者（Participants）。且节点之间可以进行网络通信。
- 所有节点都采用预写式日志，且日志被写入后即被保持在可靠的存储设备上，即使节点损坏不会导致日志数据的消失。
- 所有节点不会永久性损坏，即使损坏后仍然可以恢复。

该协议将一个分布式的事务过程拆分成两个阶段： **投票** 和 **事务提交** 。

#### 第一阶段(提交请求阶段，也被称作投票阶段)

1. 协调者节点向所有参与者节点询问是否可以执行提交操作，并开始等待各参与者节点的响应。
2. 参与者节点执行询问发起为止的所有事务操作，并将Undo信息和Redo信息写入日志。
3. 各参与者节点响应协调者节点发起的询问。如果参与者节点的事务操作实际执行成功，则它返回一个"同意"消息；如果参与者节点的事务操作实际执行失败，则它返回一个"中止"消息。

#### 第二阶段(提交执行阶段，也被称作完成阶段)

##### 成功

当协调者节点从所有参与者节点获得的响应消息都为"同意"时：

1. 协调者节点向所有参与者节点发出"正式提交"的请求。
2. 参与者节点正式完成操作，并释放在整个事务期间内占用的资源。
3. 参与者节点向协调者节点发送"完成"消息。
4. 协调者节点收到所有参与者节点反馈的"完成"消息后，完成事务。

##### 失败

如果任一参与者节点在第一阶段返回的响应消息为"终止"，或者协调者节点在第一阶段的询问超时之前无法获取所有参与者节点的响应消息时：

1. 协调者节点向所有参与者节点发出"回滚操作"的请求。
2. 参与者节点利用之前写入的Undo信息执行回滚，并释放在整个事务期间内占用的资源。
3. 参与者节点向协调者节点发送"回滚完成"消息。
4. 协调者节点收到所有参与者节点反馈的"回滚完成"消息后，取消事务。

二阶段提交还是有几个缺点的：

1. 执行过程中，所有参与节点都是事务阻塞型的。
2. 一旦协调者发生故障。参与者会一直阻塞下去。
3. 数据不一致
4. 协调者发出Commmit消息之后宕机的情况，导致对某一事务的不确定性

### 参考

[二阶段提交](https://zh.wikipedia.org/zh-hans/%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4)

## 三阶段提交协议

三阶段提交是为解决两阶段提交协议的缺点而设计的。

三阶段提交有两个改动点：

1. 同时在协调者和参与者中都引入超时机制
2. 在第一阶段和第二阶段中插入一个准备阶段，保证了在最后提交阶段之前各参与节点状态的一致。

### 参考

[三阶段提交](https://zh.wikipedia.org/wiki/%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4)

[分布式一致性之两阶段提交协议、三阶提交协议](https://zhuanlan.zhihu.com/p/35616810)
